var KomeiInput=function(){"use strict";function t(t,e){this.el=t,this.options=e}function e(e,i){return t.normalizeQuery(e)===t.normalizeQuery(i)}return t.normalizeQuery=function(t){return t.replace(/^\s*/g,"").replace(/\s{2,}/g," ")},_.mixin(t.prototype,{_initialize:function(){this.query="",this.bind(),this._onInput()},_onInput:function(){this._setQuery(this.getInputValue())},_setQuery:function(t,i){var n,s;t.length<this.options.minLength||(n=e(t,this.query),s=n?this.query.length!==t.length:!1,this.query=t,n?s&&this.emit("whitespaceChanged",this.query):this.emit("queryChanged",this.query))},initialize:function(){this._initialize()},getInputValue:function(){return this.el.value},setInputValue:function(t){this.el.value=t},resetInputValue:function(){this.setInputValue(this.query)},emit:function(t,e){var i=new CustomEvent(t,{detail:e});this.el.dispatchEvent(i)},bind:function(){var t=this;t.el.onkeyup=function(e){e||(e=window.event);var i=e.keyCode||e.which;"onType"===t.options.mode?t._onInput():"13"==i&&t._onInput()}}}),t}(),KomeiSearchResults=function(){"use strict";function t(t){return this.options=_.extend(this.defaults(),t),this.EMBED_KEY=this.options.key||"",this.limit=this.options.limit||5,this._validateEmbedKey()?void 0:void(this.blocked=!0)}function e(t){window.console&&window.console.error(t)}function i(t,e){if("js"==e){var i=document.createElement("script");i.setAttribute("type","text/javascript"),i.setAttribute("src",t)}else if("css"==e){var i=document.createElement("link");i.setAttribute("rel","stylesheet"),i.setAttribute("type","text/css"),i.setAttribute("href",t)}"undefined"!=typeof i&&document.getElementsByTagName("head")[0].appendChild(i)}function n(t){var e=parseInt(t,10),i=Math.floor(e/3600),n=Math.floor((e-3600*i)/60),s=e-3600*i-60*n;10>i&&(i="0"+i),10>n&&(n="0"+n),10>s&&(s="0"+s),i=i>0?i+":":"";var o=i+n+":"+s;return o}function s(t,e,i){if(!t)return"";if(!i||!e)return t;var n,s=!0;if(t.indexOf("#")>0){var o=t.indexOf("#");n=t.substring(t.indexOf("#"),t.length)}else n="",o=t.length;var r=t.substring(0,o),l=r.split("?"),u="";if(l.length>1)for(var a=l[1].split("&"),c=0;c<a.length;c++){var h=a[c].split("=");s&&h[0]==e||(""==u?u="?":u+="&",u+=h[0]+"="+(h[1]?h[1]:""))}return""==u&&(u="?"),""!==u&&"?"!=u&&(u+="&"),u+=e+"="+(i?i:""),l[0]+u+n}return _.mixin(t.prototype,{defaults:function(){var t=this;return{domain:"https://koemei.com",searchAPI:"/api/search/files",prefetchAPI:"/api/files",width:"500px",prefetch:!0,showTranscript:!0,target:"self",openOnSelect:!1,limit:5,mode:"onType",minLength:1,templates:{searching:"Searching ...",noResults:"No results found. Try another query.",suggestion:function(e){return t._getSuggestionTemplate(e)}},css:"http://iplusstd.com/koemei/search-results-plugin/dist/style.min.css",fontcss:"https://koemei.com/css/font.css"}},_validateEmbedKey:function(){return this.EMBED_KEY&&""!==this.EMBED_KEY?!0:(e("Koemei's Embed Key is required"),!1)},_addCSS:function(){this.options.css&&i(this.options.css,"css"),this.options.fontcss&&i(this.options.fontcss,"css")},_linkElements:function(t,i){if(!t)return e("first parameter must be an input field.");if(!i)return e("second parameter must be a dom element.");this.input=new KomeiInput(t,this.options),this.linkedEl=i,this.linkedEl.innerHTML="";var n=document.createElement("div");n.className="k-results",this.linkedEl.appendChild(n),this.resultsDom=n},_setWidth:function(){this.options.width&&(this.linkedEl.style.width=this.options.width)},_initialize:function(t,e){this.blocked||(this._linkElements(t,e),this._addCSS(),this.clear(),this._setWidth(),this._initEngine(),this._resetSuggestionElement(),this._start())},_start:function(){var t=this;t.input&&(this.input.el.addEventListener("queryChanged",function(e){t.update(e.detail)}),this.input.initialize())},_initEngine:function(){var t=this,i=t.EMBED_KEY,n={initialize:!1,datumTokenizer:function(t){return Bloodhound.tokenizers.whitespace(t._id)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:t.options.domain+t.options.searchAPI,dataType:"jsonp",transform:function(t){return t.results},replace:function(t,e){return t+"?token="+i+"&transcripts=true&q="+e}},identify:function(t){return t._id}};t.options.prefetch&&(n.prefetch={url:t.options.domain+t.options.prefetchAPI+"?token="+i,dataType:"jsonp"}),t.engine=new Bloodhound(n),t.engine.initialize().fail(function(){e("[Bloodhound error]")})},_overwrite:function(t,e){e=e||[],e.length?this._renderSuggestions(t,e):this.options.templates.searching?this._renderSearching(t):this._empty()},_append:function(t,e){e=e||[],e.length&&this.suggestionEl?this._appendSuggestions(t,e):e.length?this._renderSuggestions(t,e):!this.suggestionEl&&this.options.templates.noResults&&this._renderNoResults(t)},_renderSuggestions:function(t,e){var i=document.createElement("div");i.className="k-suggestions",i.innerHTML="",this.resultsDom.innerHTML="",this.resultsDom.appendChild(i),this.resultsDom.appendChild(this._getFooter(t,e)),this.suggestionEl=i,this._appendSuggestions(t,e)},_appendSuggestions:function(t,e){for(var i=this,n=0;n<e.length;n++)i.suggestionEl.appendChild(i._getSuggestionElement(e[n]))},_resetSuggestionElement:function(){this.suggestionEl=null,delete this.suggestionEl},_renderSearching:function(t){this._resetSuggestionElement(),this.resultsDom.innerHTML='<div class="k-searching">'+this.options.templates.searching+"</div>"},_renderNoResults:function(t){this._resetSuggestionElement(),this.resultsDom.innerHTML='<div class="k-no-results">'+this.options.templates.noResults+"</div>"},_empty:function(){this._resetSuggestionElement(),this.resultsDom.innerHTML=""},_getFooter:function(t,e){var i=document.createElement("div");return i.className="k-results-footer",i.innerHTML='powered by <a href="//koemei.com" target="_blank"><img src="https://koemei.com/img/logo.svg" alt="koemei" /></a>',i},_getSuggestionElement:function(t){var e=document.createElement("div");return e.className="k-suggestion",e.innerHTML=this.options.templates.suggestion(t),e},_getSuggestionTemplate:function(t){var e=this,i=t.pictureUrl||"http://d3m8q0cwynqlq3.cloudfront.net/images/koemei-media-thumb.jpg",o=t.created.substring(0,10),r="",l=n(t.length),u=e.options.openOnSelect?"openOnSelect":"",r='<div class="'+u+'"><div class="wrapper-item"><div class="wrapper-info"><a class="img-item koemei-pullLeft" href="'+t.srcUrl+'"><div class="gradient"></div><img src="'+i+'" alt=""><div class="time-item">'+l+'</div></a><a href="'+t.srcUrl+'"><div class="wrapper-title"><div class="title-item">'+t.name+'</div><div class="date-item">'+o+" Â· by "+t.creator.displayName+"</div></div></a> </div></div>";if(e.options.showTranscript&&t.matchingTranscripts&&t.matchingTranscripts.list){r+='<ul class="MediaListItem-segments active">';for(var a,c,h=0;2>h&&h<t.matchingTranscripts.list.length;h++)a=t.matchingTranscripts.list[h],c=a.start/100,r+='<li><a href="'+s(t.srcUrl,"time",c)+'"><span class="koemei-blue time">'+n(c)+'</span> <div class="MediaListItem-segment">'+a.highlight+"</div></a></li>";r+="</ul>"}return r+="</div>"},initialize:function(t,e){return this._initialize(t,e)},update:function(t){function e(e){o||(o=!0,e=(e||[]).slice(0,n.limit),r=e.length,n._overwrite(t,e))}function i(e){e=e||[],!s&&r<n.limit&&(n.cancel=function(){},r+=e.length,n._append(t,e.slice(0,n.limit-r)))}var n=this,s=!1,o=!1,r=0;this.cancel(),this.cancel=function(){s=!0,n.cancel=function(){}},n.engine.search(t,e,i),!o&&e([])},cancel:function(){},clear:function(){this._empty(),this.cancel()}}),t}();